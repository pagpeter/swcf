<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloudflare payload decryptor</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"
      integrity="sha512-qtX0GLM3qX8rxJN1gyDfcnMFFrKvixfoEOwbBib9VafR5vbChV5LeE5wSI/x+IlCkTY5ZFddFDCCfaVJJNnuKQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <h1>Cloudflare payload decryptor (lz-encrypt)</h1>
    <label for="key">Encryption key or script</label>
    <textarea id="key" />
    <br />

    <label for="payload">Payload</label>
    <textarea id="payload" />

    <br /><br />
    <button onmousedown="decrypt()">Decrypt</button>
    <hr />
    <textarea id="result" disabled style="width: 99.5%" rows="20"></textarea>
  </body>

  <script>
    function extractKey(script) {
      const split = script.match(/en-us(.)/)[1];
      const regex = new RegExp(
        `\\${split}([a-zA-Z0-9\\+\\-\\$]{65})\\${split}`,
        "i"
      );
      return script.match(regex)[1];
    }

    function getBaseValue(alphabet, character) {
      var baseReverseDic = {};
      if (!baseReverseDic[alphabet]) {
        baseReverseDic[alphabet] = {};
        for (var i = 0; i < alphabet.length; i++) {
          baseReverseDic[alphabet][alphabet.charAt(i)] = i;
        }
      }
      return baseReverseDic[alphabet][character];
    }

    const utils = {
      compress: (input, key) => {
        return LZString._compress(input, 6, (a) => key.charAt(a));
      },
      decompress: (input, key) => {
        input = input.replace(/ /g, "+");
        return LZString._decompress(input.length, 32, (index) =>
          getBaseValue(key, input.charAt(index))
        );
      },
    };

    const decrypt = () => {
      const rawKey = document.getElementById("key").value;
      const rawPayload = document.getElementById("payload").value;

      let key = rawKey.length === 65 ? rawKey : extractKey(rawKey);
      document.getElementById("key").value = key;

      let payload = rawPayload
        .split("=")[1]
        .replaceAll("%2b", "+")
        .replaceAll(" ", "+");
      console.log("key:", key);
      console.log("Payload:", payload);
      const res = utils.decompress(payload, key);
      console.log("Result:", res);
      if (!res) return alert("Invalid key for payload");
      document.getElementById("result").value = JSON.stringify(
        JSON.parse(res),
        null,
        "\t"
      );
    };
  </script>
</html>
